---
import "../../styles/article.css";

import type { CollectionEntry } from "astro:content";
import { getCollection, render } from "astro:content";
import { giscus } from "spectre:globals";
import { SITE } from "../../constants";
import type { GetStaticPaths } from "astro";
import Layout from "../../layouts/Layout.astro";

/**
 * Estimates the time it takes to read a post in minutes
 */
function timeToRead(post: CollectionEntry<"posts">): number {
  const numWords = (post.body || "")
    .replace(/.*\[(.*?)\].*/gm, "$1")
    .replace(/```.*?```/gms, "")
    .split(/\s+/).length;

  const numImages = post.body?.match(/!\[/g)?.length || 0;
  const numCodeblocks = post.body?.match(/```/g)?.length || 0;

  return (
    Math.ceil(numWords / 200) +
    Math.ceil(numImages / 6) +
    Math.ceil(numCodeblocks / 3)
  );
}

interface Props {
  post: CollectionEntry<"posts">;
}

const { post } = Astro.props;

export const getStaticPaths = (async () => {
  const posts = await getCollection(
    "posts",
    (post) => post.data.draft !== true,
  );

  return posts.map((post) => ({ params: { post: post.id }, props: { post } }));
}) satisfies GetStaticPaths;

const { Content, headings } = await render(post);
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  article={{
    createdAt: post.data.createdAt,
    updatedAt: post.data.updatedAt,
  }}
>
  <div class="article-detail-page">
    <header class="article-detail-header" data-pagefind-ignore>
      <div class="header-content container">
        <h1 class="article-h1">{post.data.title}</h1>
        <p class="article-description">{post.data.description}</p>
        <div class="article-tags">
          {post.data.tags.map((tag) => <span class="tag-badge">{tag.id}</span>)}
        </div>

        <div class="article-meta-row">
          <div class="meta-item">
            <span class="meta-label">Author</span>
            <span class="meta-value">{SITE.defaultAuthor || "Admin"}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Published</span>
            <span class="meta-value">
              {
                post.data.createdAt.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })
              }
            </span>
          </div>
        </div>
      </div>
    </header>

    <div class="article-detail-body container">
      <div class="article-layout">
        <article class="article-main" data-pagefind-body>
          <Content />

          <hr class="end-of-article" />

          <div class="article-footer-nav">
            <a href="/" class="back-link">‚Üê Back to Blog</a>
          </div>

          {
            giscus && (
              <div class="comments-section">
                <h2 id="comments">Comments</h2>
                <script
                  is:inline
                  src="https://giscus.app/client.js"
                  data-repo={giscus.repository}
                  data-repo-id={giscus.repositoryId}
                  data-category={giscus.category}
                  data-category-id={giscus.categoryId}
                  data-mapping={giscus.mapping}
                  data-strict={giscus.strict === true ? "1" : "0"}
                  data-reactions-enabled={
                    giscus.reactionsEnabled === true ? "1" : "0"
                  }
                  data-emit-metadata={giscus.emitMetadata === true ? "1" : "0"}
                  data-input-position={giscus.commentsInput}
                  data-theme="light"
                  data-lang={giscus.lang}
                  data-loading="lazy"
                  crossorigin="anonymous"
                  async
                />
              </div>
            )
          }
        </article>

        <aside class="article-sidebar" data-pagefind-ignore>
          {
            headings.length > 0 && (
              <nav class="toc-nav">
                <h3>On this page</h3>
                <ul>
                  {headings.map((heading) => (
                    <li class={`toc-depth-${heading.depth}`}>
                      <a href={`#${heading.slug}`}>{heading.text}</a>
                    </li>
                  ))}
                </ul>
              </nav>
            )
          }
        </aside>
      </div>
    </div>
  </div>
  <script>
    const observerOptions = {
      root: null,
      rootMargin: "0px 0px -80% 0px",
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const id = entry.target.getAttribute("id");
        if (entry.isIntersecting && id) {
          document.querySelectorAll(".toc-nav a").forEach((link) => {
            link.classList.remove("active");
            if (link.getAttribute("href") === `#${id}`) {
              link.classList.add("active");
            }
          });
        }
      });
    }, observerOptions);

    document
      .querySelectorAll("article h1, article h2, article h3, article h4")
      .forEach((section) => {
        observer.observe(section);
      });
  </script>
</Layout>

<style>
  .article-detail-page {
    background-color: var(--color-bg-primary);
  }

  .article-detail-header {
    background-color: var(--color-bg-secondary);
    padding: var(--space-12) 0 var(--space-12);
    border-bottom: 1px solid var(--color-border-light);
  }

  .header-content {
    max-width: var(--layout-max-width);
  }

  .article-h1 {
    font-size: 3rem;
    margin: 0 0 var(--space-4);
    line-height: 1.1;
    font-weight: 700;
    font-family: var(--font-serif);
  }

  .article-description {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
    max-width: 800px;
    margin-bottom: var(--space-6);
    line-height: var(--line-height-tight);
  }

  .article-tags {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
  }

  .tag-badge {
    text-transform: uppercase;
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
    font-weight: 500;
    letter-spacing: 0.05em;
  }

  .article-meta-row {
    display: flex;
    gap: var(--space-12);
    border-top: 1px solid var(--color-border);
    padding-top: var(--space-6);
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .meta-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--color-text-muted);
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .meta-value {
    font-size: 0.9rem;
    color: var(--color-text-primary);
    font-weight: 500;
  }

  .article-detail-body {
    padding-top: var(--space-12);
    padding-bottom: var(--space-16);
  }

  .article-layout {
    display: grid;
    grid-template-columns: 1fr var(--sidebar-width);
    gap: var(--space-16);
    align-items: start;
  }

  .article-main {
    max-width: var(--content-max-width);
    min-width: 0;
  }

  .article-sidebar {
    position: sticky;
    top: calc(var(--space-16) + 60px);
  }

  .toc-nav h3 {
    font-size: 0.8rem;
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
    letter-spacing: 0.05em;
    font-weight: 600;
    font-family: var(--font-sans);
  }

  .toc-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    border-left: 1px solid var(--color-border);
  }

  .toc-nav li {
    margin: 0;
  }

  .toc-nav a {
    display: block;
    padding: var(--space-1) var(--space-4);
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    line-height: var(--line-height-tight);
    border-left: 2px solid transparent;
    margin-left: -1px;
    transition: all var(--transition-fast);
  }

  .toc-nav a:hover,
  .toc-nav a.active {
    color: var(--color-accent);
    border-left-color: var(--color-accent);
    background-color: var(--color-bg-secondary);
  }

  .toc-depth-3 {
    padding-left: var(--space-4);
  }
  .toc-depth-4 {
    padding-left: var(--space-8);
  }

  .article-footer-nav {
    margin-top: var(--space-12);
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-border-light);
  }

  .back-link {
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .comments-section {
    margin-top: var(--space-16);
    padding-top: var(--space-12);
    border-top: 2px solid var(--color-bg-secondary);
  }

  .comments-section h2 {
    font-size: 1.5rem;
    margin-bottom: var(--space-8);
    font-family: var(--font-serif);
  }

  @media screen and (max-width: 1024px) {
    .article-layout {
      grid-template-columns: 1fr;
    }
    .article-sidebar {
      display: none;
    }
  }

  @media screen and (max-width: 768px) {
    .article-h1 {
      font-size: 2.25rem;
    }
    .article-detail-header {
      padding: var(--space-8) 0;
    }
    .article-meta-row {
      flex-direction: column;
      gap: var(--space-4);
    }
  }
</style>
